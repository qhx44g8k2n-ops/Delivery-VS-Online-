<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crispy Chicken | Business Intelligence System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #D32F2F; --primary-dark: #b71c1c; --primary-light: #ffcdd2;
            --secondary: #FFC107; --secondary-dark: #ffb300;
            --success: #388E3C; --warning: #F57C00; --danger: #D32F2F;
            --bg-body: #f4f7f6; --bg-panel: #ffffff; --text-main: #2c3e50; --text-muted: #7f8c8d;
            --border: #e2e8f0;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', 'Inter', 'Roboto', sans-serif; margin:0; padding:0; }
        body { background-color: var(--bg-body); color: var(--text-main); height:100vh; display:flex; overflow:hidden; }

        /* SIDEBAR */
        aside { width:250px; background:#1a202c; color:white; display:flex; flex-direction:column; border-right:1px solid #2d3748; z-index:20; flex-shrink:0; }
        .brand { padding:24px; display:flex; align-items:center; background:linear-gradient(135deg, var(--primary), var(--primary-dark)); font-weight:800; font-size:1.2rem; letter-spacing:0.5px; }
        .brand span { color:var(--secondary); margin-left:8px; }
        .nav-menu { flex:1; padding:20px 10px; display:flex; flex-direction:column; gap:8px; }
        .nav-item { padding:12px 16px; cursor:pointer; color:rgba(255,255,255,0.7); display:flex; align-items:center; gap:12px; border-radius:8px; transition:all 0.2s; font-size:0.95rem; }
        .nav-item:hover { background:rgba(255,255,255,0.1); color:white; }
        .nav-item.active { background:var(--primary); color:white; font-weight:600; box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4); }

        /* MAIN LAYOUT */
        main { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; }
        .top-bar { background:white; padding:16px 30px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; z-index:10; }
        .view-container { flex:1; overflow-y:auto; overflow-x:hidden; padding:25px; position:relative; }

        .header-title h2 { font-size:1.5rem; color:var(--text-main); font-weight:700; }
        .header-title p { font-size:0.9rem; color:var(--text-muted); margin-top:4px; }
        
        .controls { display:flex; gap:12px; align-items:center; }
        .search-bar { position:relative; }
        .search-bar input { padding:8px 12px 8px 35px; border-radius:6px; border:1px solid #ddd; font-size:0.9rem; width:250px; }
        .search-bar i { position:absolute; left:12px; top:10px; color:#999; }

        .filter-toggle { display:flex; background:#f1f1f1; border-radius:8px; padding:4px; border:1px solid #ddd; }
        .filter-opt { padding:8px 16px; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:600; color:#666; transition:0.2s; }
        .filter-opt.active { background:white; color:var(--primary); box-shadow:0 2px 4px rgba(0,0,0,0.05); }

        /* COMPONENTS */
        .card { background:white; border-radius:12px; box-shadow:var(--shadow); padding:25px; margin-bottom:25px; border:1px solid var(--border); }
        .table-wrapper { overflow-x:auto; border-radius:8px; border:1px solid var(--border); }
        table { width:100%; border-collapse:collapse; font-size:0.9rem; min-width: 1000px; }
        
        th { background:#f8fafc; color:var(--text-muted); font-weight:700; text-align:center; padding:14px 12px; border-bottom:2px solid var(--border); white-space: nowrap; text-transform: uppercase; font-size:0.75rem; letter-spacing:0.5px; }
        td { padding:12px; border-bottom:1px solid #f1f5f9; text-align:center; white-space: nowrap; vertical-align: middle; color:#334155; }

        /* Status & Indicators */
        .status-badge { padding:4px 10px; border-radius:20px; font-size:0.75rem; font-weight:700; text-transform: uppercase; display:inline-block; }
        .status-success { background:#dcfce7; color:#166534; } /* Green */
        .status-danger { background:#fee2e2; color:#991b1b; } /* Red */
        .status-warning { background:#ffedd5; color:#9a3412; } /* Orange */

        /* Dashboard Grids */
        .kpi-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:20px; margin-bottom:25px; }
        .kpi-card { background:white; padding:20px; border-radius:10px; box-shadow:var(--shadow); border-left:5px solid var(--primary); transition:transform 0.2s; }
        .kpi-card:hover { transform:translateY(-2px); }
        .kpi-title { font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-weight:700; }
        .kpi-value { font-size:2rem; font-weight:800; color:var(--text-main); margin-top:8px; line-height:1.2; }
        .kpi-sub { font-size:0.8rem; color:var(--success); margin-top:6px; font-weight:600; }

        .charts-grid { display:grid; grid-template-columns: 2fr 1fr; gap:25px; margin-bottom:25px; }
        .chart-container { height:320px; position:relative; }
        
        /* Modals */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; justify-content:center; align-items:center; backdrop-filter:blur(3px); }
        .modal-content { background:white; padding:35px; border-radius:12px; width:550px; box-shadow:0 25px 50px rgba(0,0,0,0.2); animation: slideUp 0.3s ease; max-height:90vh; overflow-y:auto;}
        @keyframes slideUp { from {transform:translateY(30px); opacity:0;} to {transform:translateY(0); opacity:1;} }

        /* Forms */
        .form-group { margin-bottom:18px; }
        .form-group label { display:block; font-size:0.85rem; font-weight:700; margin-bottom:8px; color:#475569; }
        .form-control { width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:6px; font-size:0.95rem; transition:border 0.2s; }
        .form-control:focus { outline:none; border-color:var(--primary); }

        /* Buttons */
        .btn { padding:10px 20px; border-radius:6px; border:none; cursor:pointer; font-weight:600; display:inline-flex; align-items:center; gap:8px; font-size:0.9rem; transition:0.2s; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        .btn-primary { background:var(--primary); color:white; }
        .btn-primary:hover { background:var(--primary-dark); }
        .btn-secondary { background:white; border:1px solid #e2e8f0; color:#475569; }
        .btn-secondary:hover { background:#f8fafc; }
        .btn-danger { background:var(--danger); color:white; }
        .btn-sm { padding:6px 12px; font-size:0.8rem; }
        
        .view { display:none; }
        .view.active { display:block; animation:fadeIn 0.4s ease; }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }

        /* Report Styles */
        .report-summary { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px; }
        .report-box { background:#f8fafc; padding:20px; border-radius:8px; border:1px solid #e2e8f0; }
        .report-box h4 { color:var(--primary); margin-bottom:15px; font-size:1rem; }
        .report-list { list-style:none; }
        .report-list li { padding:8px 0; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; font-size:0.9rem; }
        .report-list li:last-child { border-bottom:none; }
        .report-list span.val { font-weight:bold; }

        /* Toast */
        .toast { position:fixed; bottom:30px; right:30px; background:#1e293b; color:white; padding:14px 24px; border-radius:8px; z-index:200; transform:translateY(100px); transition:0.3s; box-shadow:0 10px 15px rgba(0,0,0,0.2); font-weight:500; }
        .toast.show { transform:translateY(0); }

        /* Print */
        @media print {
            aside, .top-bar, .controls, .no-print { display:none !important; }
            .view-container { padding:0; overflow:visible; }
            body, main { height:auto; overflow:visible; background:white; }
            .card { border:none; box-shadow:none; padding:0; margin-bottom:0; }
            .charts-grid { display:block; }
            .chart-container { height:300px; page-break-inside: avoid; margin-bottom:30px; }
            table { min-width:100%; border:1px solid #000; }
            th, td { border:1px solid #000; }
        }
    </style>
</head>
<body>

<aside id="sidebar">
    <div class="brand"><i class="fas fa-drumstick-bite"></i> <span>CRISPY BI</span></div>
    <div class="nav-menu">
        <div class="nav-item active" onclick="app.switchTab('dashboard')">
            <i class="fas fa-chart-pie"></i> Dashboard
        </div>
        <div class="nav-item" onclick="app.switchTab('matrix')">
            <i class="fas fa-table"></i> Daily Matrix
        </div>
        <div class="nav-item" onclick="app.switchTab('agents')">
            <i class="fas fa-users"></i> Agent Performance
        </div>
        <div class="nav-item" onclick="app.switchTab('reports')">
            <i class="fas fa-file-invoice-dollar"></i> Executive Reports
        </div>
        <div class="nav-item" onclick="app.switchTab('settings')">
            <i class="fas fa-cog"></i> Settings
        </div>
    </div>
</aside>

<main>
    <div class="top-bar">
        <div class="header-title">
            <h2 id="pageTitle">Dashboard</h2>
            <p>Performance Overview & Business Intelligence</p>
        </div>
        <div class="controls">
            <button class="btn btn-secondary" onclick="window.print()"><i class="fas fa-print"></i> Print Report</button>
            <button class="btn btn-primary" id="mainAddBtn" onclick="app.openBranchModal()"><i class="fas fa-plus"></i> Add Data</button>
        </div>
    </div>

    <div class="view-container">
        
        <!-- 1. DASHBOARD VIEW -->
        <div id="view-dashboard" class="view active">
            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card" style="border-left-color: var(--primary);">
                    <div class="kpi-title">Total Revenue</div>
                    <div class="kpi-value" id="kpi-total-sales">AED 0</div>
                    <div class="kpi-sub"><i class="fas fa-arrow-up"></i> All Channels</div>
                </div>
                <div class="kpi-card" style="border-left-color: var(--secondary);">
                    <div class="kpi-title">Total Transactions</div>
                    <div class="kpi-value" id="kpi-total-txn">0</div>
                </div>
                <div class="kpi-card" style="border-left-color: var(--success);">
                    <div class="kpi-title">Avg Order Value (ATV)</div>
                    <div class="kpi-value" id="kpi-atv">AED 0</div>
                </div>
                <div class="kpi-card" style="border-left-color: #6366f1;">
                    <div class="kpi-title">Agent Achievement</div>
                    <div class="kpi-value" id="kpi-agent-achv">0%</div>
                    <div class="kpi-sub">Avg Target Completion</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <h3>Revenue & Volume Trend</h3>
                        <select id="chartBranchFilter" onchange="app.updateCharts()" style="padding:6px; border-radius:4px; border:1px solid #ddd;">
                            <option value="all">All Branches</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:20px;">Branch Efficiency</h3>
                    <div class="chart-container">
                        <canvas id="avrChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. DAILY MATRIX VIEW -->
        <div id="view-matrix" class="view">
            <div class="filter-toggle no-print" style="margin-bottom:20px;">
                <div class="filter-opt active" onclick="app.setChannel('delivery', this)">
                    <i class="fas fa-motorcycle"></i> Delivery
                </div>
                <div class="filter-opt" onclick="app.setChannel('online', this)">
                    <i class="fas fa-globe"></i> Online
                </div>
            </div>
            <div class="table-wrapper">
                <table id="matrixTable">
                    <thead></thead>
                    <tbody></tbody>
                    <tfoot></tfoot>
                </table>
            </div>
        </div>

        <!-- 3. AGENT PERFORMANCE VIEW -->
        <div id="view-agents" class="view">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;" class="no-print">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="agentSearch" placeholder="Search agent..." onkeyup="app.renderAgentTable()">
                </div>
                <button class="btn btn-primary" onclick="app.openAgentModal()"><i class="fas fa-plus"></i> New Entry</button>
            </div>

            <div class="table-wrapper">
                <table id="agentTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Agent Name</th>
                            <th>Branch</th>
                            <th>Orders</th>
                            <th>Sales</th>
                            <th>ATV</th>
                            <th>Target</th>
                            <th>Achv %</th>
                            <th>Cum Var</th>
                            <th>Status</th>
                            <th class="no-print">Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 4. EXECUTIVE REPORTS VIEW -->
        <div id="view-reports" class="view">
            <h3 style="margin-bottom:20px; color:var(--primary);">Executive Summary</h3>
            
            <div class="report-summary" style="margin-bottom:30px;">
                <!-- Performance Highlights -->
                <div class="report-box">
                    <h4><i class="fas fa-trophy"></i> Top Performers (Today)</h4>
                    <ul class="report-list" id="report-top-branches"></ul>
                </div>

                <!-- Critical Insights -->
                <div class="report-box">
                    <h4><i class="fas fa-exclamation-triangle" style="color:var(--warning)"></i> Needs Attention</h4>
                    <ul class="report-list" id="report-low-performers"></ul>
                </div>

                <!-- Target Stats -->
                <div class="report-box">
                    <h4><i class="fas fa-bullseye"></i> Target Analysis</h4>
                    <ul class="report-list" id="report-target-stats"></ul>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                    <h3>Detailed Agent Ranking</h3>
                    <select id="reportSort" onchange="app.renderReports()" style="padding:6px;">
                        <option value="sales">Sort by Total Sales</option>
                        <option value="achv">Sort by Target %</option>
                    </select>
                </div>
                <div class="table-wrapper">
                    <table id="reportTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Agent</th>
                                <th>Total Sales</th>
                                <th>Cumulative ATV</th>
                                <th>Target Met?</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 5. SETTINGS VIEW -->
        <div id="view-settings" class="view">
            <h3 style="margin-bottom:20px;">System Configuration</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <h4>Branches</h4>
                        <button class="btn btn-sm btn-primary" onclick="app.openAddBranchModal()"><i class="fas fa-plus"></i> Add</button>
                    </div>
                    <table>
                        <thead><tr><th>Name</th><th>Action</th></tr></thead>
                        <tbody id="settingsBranchTable"></tbody>
                    </table>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <h4>Agents</h4>
                        <button class="btn btn-sm btn-primary" onclick="app.openAddAgentModal()"><i class="fas fa-plus"></i> Add</button>
                    </div>
                    <table>
                        <thead><tr><th>Name</th><th>Action</th></tr></thead>
                        <tbody id="settingsAgentTable"></tbody>
                    </table>
                </div>
            </div>
            <div class="card" style="border-left-color: var(--danger); margin-top:20px;">
                <h4>Data Management</h4>
                <p style="color:#666; margin-bottom:15px;">Reset all recorded data. This action is irreversible.</p>
                <button class="btn btn-danger btn-sm" onclick="app.resetSystem()">Reset All Data</button>
            </div>
        </div>

    </div>
</main>

<!-- MODALS -->
<div id="branchModal" class="modal">
    <div class="modal-content">
        <h3 id="branchModalTitle" style="margin-bottom:25px; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:10px;">Update Branch Data</h3>
        <form id="branchForm" onsubmit="app.saveBranchData(event)">
            <input type="hidden" id="editBranchId">
            <div class="form-group">
                <label>Channel</label>
                <select id="inpBranchChannel" class="form-control">
                    <option value="delivery">Delivery</option>
                    <option value="online">Online</option>
                </select>
            </div>
            <div style="display:flex; gap:15px;">
                <div class="form-group" style="flex:1;">
                    <label>Day</label>
                    <input type="number" id="inpDay" required class="form-control" min="1" max="31">
                </div>
                <div class="form-group" style="flex:1.5;">
                    <label>Branch</label>
                    <select id="inpBranch" required class="form-control"></select>
                </div>
            </div>
            <div style="display:flex; gap:15px;">
                <div class="form-group" style="flex:1;">
                    <label>Sales (AED)</label>
                    <input type="number" id="inpSales" required class="form-control" min="0">
                </div>
                <div class="form-group" style="flex:1;">
                    <label>Transactions</label>
                    <input type="number" id="inpTxn" required class="form-control" min="0">
                </div>
            </div>
            <div class="form-group">
                <label>ATV (Auto-calculated)</label>
                <input type="number" id="inpAvr" step="0.01" class="form-control" readonly style="background:#f8fafc;">
            </div>
            <div style="text-align:right; margin-top:20px;">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('branchModal').style.display='none'">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Record</button>
            </div>
        </form>
    </div>
</div>

<div id="agentModal" class="modal">
    <div class="modal-content">
        <h3 id="agentModalTitle" style="margin-bottom:25px; color:#673ab7; border-bottom:1px solid #eee; padding-bottom:10px;">Agent Daily Log</h3>
        <form id="agentForm" onsubmit="app.saveAgentData(event)">
            <input type="hidden" id="editAgentDate">
            <input type="hidden" id="editAgentName">
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="agentDate" required class="form-control">
            </div>
            <div class="form-group">
                <label>Agent Name</label>
                <select id="agentName" required class="form-control"></select>
            </div>
            <div style="display:flex; gap:15px;">
                <div class="form-group" style="flex:1;">
                    <label>Total Orders</label>
                    <input type="number" id="agentOrders" required class="form-control" min="0" oninput="app.calcAgentPreview()">
                </div>
                <div class="form-group" style="flex:1;">
                    <label>Total Sales</label>
                    <input type="number" id="agentSales" required class="form-control" min="0" oninput="app.calcAgentPreview()">
                </div>
            </div>
            <div style="display:flex; gap:15px;">
                <div class="form-group" style="flex:1;">
                    <label>Daily Target</label>
                    <input type="number" id="agentTarget" required class="form-control" min="0" value="2000">
                </div>
                <div class="form-group" style="flex:1;">
                    <label>Branch</label>
                    <select id="agentBranch" required class="form-control"></select>
                </div>
            </div>
            <div style="background:#f0fdf4; padding:12px; border-radius:6px; margin-bottom:20px; border:1px solid #bbf7d0;">
                <small style="color:#166534; font-weight:600;">Preview: ATV = <span id="previewAvr">0</span> | Achievement = <span id="previewAchv">0</span>%</small>
            </div>
            <div style="text-align:right;">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('agentModal').style.display='none'">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Record</button>
            </div>
        </form>
    </div>
</div>

<!-- ADD MODALS -->
<div id="addBranchModal" class="modal">
    <div class="modal-content" style="width:400px;">
        <h3>Add New Branch</h3>
        <div class="form-group" style="margin-top:15px;">
            <label>Branch Name</label>
            <input type="text" id="newBranchName" class="form-control">
        </div>
        <div style="text-align:right;">
            <button class="btn btn-primary" onclick="app.addNewBranch()">Save</button>
        </div>
    </div>
</div>

<div id="addAgentModal" class="modal">
    <div class="modal-content" style="width:400px;">
        <h3>Add New Agent</h3>
        <div class="form-group" style="margin-top:15px;">
            <label>Agent Name</label>
            <input type="text" id="newAgentName" class="form-control">
        </div>
        <div style="text-align:right;">
            <button class="btn btn-primary" onclick="app.addNewAgent()">Save</button>
        </div>
    </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast">Action Successful</div>

<script>
    // --- CONFIGURATION & DATA ---
    const BRANCHES = ["Hamdan St", "Khalidiya", "Mussafah", "Muroor", "Al Barsha", "Al Satwa", "Al Majaz", "Al Rigga", "Al Electra", "CCM"];
    const AGENTS = ["manju ranabhat", "NONA Rose", "Melvin compendio", "SALEH EMAD", "Asmita Sapkota", "NIRJALA MAHRJAN", "jasmen"];

    function createRecord(day, branch, sales, txn, avr) {
        return { day: parseInt(day), branch, sales: parseFloat(sales), txn: parseFloat(txn), avr: parseFloat(avr) };
    }

    // INITIAL DATA (Delivery)
    const initialDeliveryData = [
        createRecord(1, "Hamdan St", 2187, 46, 47.5), createRecord(1, "Khalidiya", 788, 19, 41.5),
        createRecord(1, "Mussafah", 1615, 27, 59.8), createRecord(1, "Muroor", 847, 20, 42.4),
        createRecord(1, "Al Barsha", 493, 11, 44.8), createRecord(1, "Al Satwa", 266, 6, 44.3),
        createRecord(1, "Al Majaz", 1103, 12, 91.9), createRecord(1, "Al Rigga", 0, 0, 0),
        createRecord(1, "Al Electra", 0, 0, 0),
        createRecord(2, "Hamdan St", 1167, 28, 41.7), createRecord(2, "Khalidiya", 922, 13, 70.9),
        createRecord(2, "Mussafah", 1025, 20, 51.3), createRecord(2, "Muroor", 743, 13, 57.2),
        createRecord(2, "Al Barsha", 655, 13, 50.4), createRecord(2, "Al Satwa", 261, 7, 37.3),
        createRecord(2, "Al Majaz", 744, 11, 67.6), createRecord(2, "Al Rigga", 0, 0, 0),
        createRecord(2, "Al Electra", 0, 0, 0),
        createRecord(3, "Hamdan St", 2303, 45, 51.2), createRecord(3, "Khalidiya", 1097, 22, 49.9),
        createRecord(3, "Mussafah", 800, 18, 44.4), createRecord(3, "Muroor", 1040, 20, 52.0),
        createRecord(3, "Al Barsha", 1000, 21, 47.6), createRecord(3, "Al Satwa", 543, 10, 54.3),
        createRecord(3, "Al Majaz", 841, 17, 49.5), createRecord(3, "Al Rigga", 0, 0, 0),
        createRecord(3, "Al Electra", 0, 0, 0)
    ];

    // INITIAL DATA (Online)
    const initialOnlineData = [
        createRecord(1, "Hamdan St", 839, 12, 69.9), createRecord(1, "Khalidiya", 281.9, 4, 70.5),
        createRecord(1, "Mussafah", 352, 7, 50.3), createRecord(1, "Muroor", 163, 2, 81.5),
        createRecord(1, "Al Barsha", 295, 5, 59.0), createRecord(1, "Al Satwa", 305, 5, 61.0),
        createRecord(2, "Hamdan St", 824, 16, 51.5), createRecord(2, "Khalidiya", 769, 11, 69.9),
        createRecord(2, "Mussafah", 190, 5, 38.0), createRecord(2, "Muroor", 217, 2, 108.5)
    ];

    // INITIAL DATA (Agents) - UPDATED WITH MANJU DATA
    const initialAgentData = [
        { date: "2026-01-20", name: "manju ranabhat", branch: "CCM", orders: 11, sales: 864, target: 2000 },
        { date: "2026-01-21", name: "manju ranabhat", branch: "Hamdan St", orders: 38, sales: 2000, target: 2000 }, // NEW DATA ADDED
        { date: "2026-01-20", name: "NONA Rose", branch: "CCM", orders: 44, sales: 1985, target: 2000 },
        { date: "2026-01-20", name: "Melvin compendio", branch: "CCM", orders: 17, sales: 1076, target: 2000 },
        { date: "2026-01-20", name: "SALEH EMAD", branch: "CCM", orders: 12, sales: 853, target: 2000 },
        { date: "2026-01-20", name: "Asmita Sapkota", branch: "CCM", orders: 13, sales: 574, target: 2000 },
        { date: "2026-01-20", name: "NIRJALA MAHRJAN", branch: "CCM", orders: 19, sales: 728, target: 2000 },
        { date: "2026-01-20", name: "jasmen", branch: "CCM", orders: 0, sales: 0, target: 0 }
    ];

    const app = {
        data: {
            delivery: [...initialDeliveryData],
            online: [...initialOnlineData],
            agents: [...initialAgentData]
        },
        currentChannel: 'delivery',
        charts: {},

        init: () => {
            app.setupUI();
            app.renderDashboard();
            app.renderTable();
            app.renderAgentTable();
            app.renderSettings();
            app.renderReports();
        },

        setupUI: () => {
            const branchSelects = ['inpBranch', 'chartBranchFilter', 'agentBranch', 'newAgentBranch'];
            branchSelects.forEach(id => {
                const sel = document.getElementById(id);
                if(!sel) return;
                sel.innerHTML = id === 'chartBranchFilter' ? '<option value="all">All Branches</option>' : '';
                BRANCHES.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b; opt.text = b;
                    sel.appendChild(opt);
                });
            });

            const agentSel = document.getElementById('agentName');
            AGENTS.forEach(a => {
                const opt = document.createElement('option');
                opt.value = a; opt.text = a;
                agentSel.appendChild(opt);
            });

            document.getElementById('inpSales').addEventListener('input', app.calcBranchAvr);
            document.getElementById('inpTxn').addEventListener('input', app.calcBranchAvr);
        },

        switchTab: (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const navMap = {'dashboard':0, 'matrix':1, 'agents':2, 'reports':3, 'settings':4};
            document.getElementById('view-'+id).classList.add('active');
            if(navMap[id] !== undefined) document.querySelectorAll('.nav-item')[navMap[id]].classList.add('active');
            
            const titleMap = {'dashboard':'Dashboard', 'matrix':'Daily Matrix', 'agents':'Agent Performance', 'reports':'Executive Reports', 'settings':'System Settings'};
            document.getElementById('pageTitle').innerText = titleMap[id];

            const addBtn = document.getElementById('mainAddBtn');
            if(id === 'agents' || id === 'reports' || id === 'settings') addBtn.style.display = 'none';
            else addBtn.style.display = 'inline-flex';
        },

        // --- DASHBOARD ---
        setChannel: (channel, el) => {
            app.currentChannel = channel;
            document.querySelectorAll('.filter-opt').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            app.renderDashboard();
            app.renderTable();
        },

        renderDashboard: () => {
            const currentData = app.getActiveData();
            const totalSales = currentData.reduce((acc, curr) => acc + curr.sales, 0);
            const totalTxn = currentData.reduce((acc, curr) => acc + curr.txn, 0);
            const globalATV = totalTxn > 0 ? (totalSales/totalTxn).toFixed(1) : 0;

            document.getElementById('kpi-total-sales').innerText = `AED ${totalSales.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            document.getElementById('kpi-total-txn').innerText = totalTxn.toLocaleString();
            document.getElementById('kpi-atv').innerText = `AED ${globalATV}`;

            let totalAchv = 0, achvCount = 0;
            app.data.agents.forEach(d => {
                if(d.target > 0) {
                    totalAchv += (d.sales/d.target)*100;
                    achvCount++;
                }
            });
            document.getElementById('kpi-agent-achv').innerText = achvCount > 0 ? (totalAchv/achvCount).toFixed(0) + '%' : '0%';

            app.updateCharts();
        },

        updateCharts: () => {
            const filterVal = document.getElementById('chartBranchFilter').value;
            const currentData = app.getActiveData();
            const maxDay = 10;
            
            let labels = Array.from({length: maxDay}, (_, i) => `Day ${i+1}`);
            let salesData = new Array(maxDay).fill(0);
            let txnData = new Array(maxDay).fill(0);

            currentData.forEach(d => {
                if(d.day <= maxDay) {
                    if(filterVal === 'all' || d.branch === filterVal) {
                        salesData[d.day-1] += d.sales;
                        txnData[d.day-1] += d.txn;
                    }
                }
            });

            if(app.charts.trend) app.charts.trend.destroy();
            if(app.charts.avr) app.charts.avr.destroy();

            app.charts.trend = new Chart(document.getElementById('trendChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Sales (AED)', data: salesData, backgroundColor: '#D32F2F', yAxisID: 'y', order: 2 },
                        { label: 'Transactions', data: txnData, type: 'line', borderColor: '#FFC107', backgroundColor: '#FFC107', yAxisID: 'y1', tension:0.3, borderWidth:2, pointRadius:3, order: 1 }
                    ]
                },
                options: { 
                    responsive:true, maintainAspectRatio:false,
                    scales:{ y:{beginAtZero:true, position:'left', title:{display:true,text:'AED'}}, y1:{position:'right', beginAtZero:true, grid:{display:false}, title:{display:true,text:'Count'}} } 
                }
            });

            let branchAvr = BRANCHES.map(b => {
                const bData = currentData.filter(x => x.branch === b);
                const s = bData.reduce((a,c)=>a+c.sales,0);
                const t = bData.reduce((a,c)=>a+c.txn,0);
                return t > 0 ? s/t : 0;
            });

            app.charts.avr = new Chart(document.getElementById('avrChart'), {
                type: 'bar',
                indexAxis: 'y',
                data: {
                    labels: BRANCHES,
                    datasets: [{
                        label: 'ATV (AED)',
                        data: branchAvr,
                        backgroundColor: branchAvr.map(v => v > 50 ? '#388E3C' : (v > 40 ? '#F57C00' : '#D32F2F')),
                        borderRadius: 4
                    }]
                },
                options: { responsive:true, maintainAspectRatio:false, scales:{ x:{beginAtZero:true, title:{display:true, text:'AED'}} } }
            });
        },

        renderTable: () => {
            const currentData = app.getActiveData();
            const tbody = document.querySelector('#matrixTable tbody');
            const thead = document.querySelector('#matrixTable thead');
            
            thead.innerHTML = `<tr><th>Day</th>${BRANCHES.map(b=>`<th>${b}</th>`).join('')}<th>TOTAL</th></tr>`;
            tbody.innerHTML = '';

            for(let day=1; day<=10; day++) {
                let rowHTML = `<tr onclick="app.editBranchData(${day})" style="cursor:pointer; hover:bg-gray-100" title="Click to Edit">`;
                rowHTML += `<td><strong>${day}</strong></td>`;
                let rowTotal = 0;
                BRANCHES.forEach(b => {
                    const d = currentData.find(x => x.day === day && x.branch === b);
                    const sales = d ? d.sales : 0;
                    rowTotal += sales;
                    rowHTML += `<td>${sales > 0 ? sales.toLocaleString(undefined, {maximumFractionDigits:0}) : '-'}</td>`;
                });
                rowHTML += `<td style="background:#f8fafc; font-weight:bold;">${rowTotal.toLocaleString(undefined, {maximumFractionDigits:0})}</td></tr>`;
                tbody.innerHTML += rowHTML;
            }
        },

        getActiveData: () => app.currentChannel === 'delivery' ? app.data.delivery : app.data.online,

        calcBranchAvr: () => {
            const s = parseFloat(document.getElementById('inpSales').value) || 0;
            const t = parseFloat(document.getElementById('inpTxn').value) || 0;
            document.getElementById('inpAvr').value = t > 0 ? (s/t).toFixed(1) : 0;
        },

        // --- AGENT LOGIC ---
        openAgentModal: () => {
            document.getElementById('agentForm').reset();
            document.getElementById('editAgentDate').value = "";
            document.getElementById('editAgentName').value = "";
            document.getElementById('agentDate').valueAsDate = new Date();
            document.getElementById('agentModal').style.display = 'flex';
            app.calcAgentPreview();
        },

        renderAgentTable: () => {
            const tbody = document.querySelector('#agentTable tbody');
            const search = document.getElementById('agentSearch').value.toLowerCase();
            
            tbody.innerHTML = '';
            const data = app.data.agents
                .filter(d => d.name.toLowerCase().includes(search) || d.branch.toLowerCase().includes(search))
                .sort((a,b) => new Date(b.date) - new Date(a.date));
            
            // --- CORRECTED CUMULATIVE LOGIC ---
            // We need to calculate CUMULATIVE totals for every agent UP TO the specific row's date
            // But for a simple table view, we usually show the "Running Total" up to TODAY.
            // Here we will calculate the Cumulative Totals for ALL records available for that agent.
            const cumStats = {};
            app.data.agents.forEach(d => {
                if(!cumStats[d.name]) cumStats[d.name] = { s:0, t:0 };
                cumStats[d.name].s += d.sales;
                cumStats[d.name].t += d.target;
            });

            data.forEach(d => {
                const avr = d.orders > 0 ? (d.sales/d.orders).toFixed(1) : "0.0";
                const pct = d.target > 0 ? ((d.sales/d.target)*100).toFixed(0) : "0";
                
                // Cumulative Stats
                const cS = cumStats[d.name].s;
                const cT = cumStats[d.name].t;
                // Cumulative Variance = (Total Sales) - (Total Targets)
                const varVal = (cS - cT).toFixed(0);

                let status = 'status-danger';
                let statusTxt = 'Below Target';
                if(parseFloat(pct) >= 100) { status='status-success'; statusTxt='Above Target'; }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${d.date}</td>
                    <td>${d.name}</td>
                    <td>${d.branch}</td>
                    <td>${d.orders}</td>
                    <td>${d.sales.toLocaleString()}</td>
                    <td>${avr}</td>
                    <td>${d.target.toLocaleString()}</td>
                    <td>${pct}%</td>
                    <td style="color:${varVal >= 0 ? 'green' : 'red'}; font-weight:bold;">${varVal}</td>
                    <td><span class="status-badge ${status}">${statusTxt}</span></td>
                    <td class="no-print"><button class="btn btn-sm btn-secondary" onclick="app.editAgentData('${d.date}', '${d.name}')">Edit</button></td>
                `;
                tbody.appendChild(tr);
            });
        },

        editAgentData: (date, name) => {
            const rec = app.data.agents.find(d => d.date === date && d.name === name);
            if(rec) {
                document.getElementById('editAgentDate').value = rec.date;
                document.getElementById('editAgentName').value = rec.name;
                document.getElementById('agentDate').value = rec.date;
                document.getElementById('agentName').value = rec.name;
                document.getElementById('agentOrders').value = rec.orders;
                document.getElementById('agentSales').value = rec.sales;
                document.getElementById('agentTarget').value = rec.target;
                document.getElementById('agentBranch').value = rec.branch;
                document.getElementById('agentModal').style.display = 'flex';
                app.calcAgentPreview();
            }
        },

        saveAgentData: (e) => {
            e.preventDefault();
            const editDate = document.getElementById('editAgentDate').value;
            const editName = document.getElementById('editAgentName').value;

            const newRec = {
                date: document.getElementById('agentDate').value,
                name: document.getElementById('agentName').value,
                orders: parseInt(document.getElementById('agentOrders').value),
                sales: parseFloat(document.getElementById('agentSales').value),
                target: parseFloat(document.getElementById('agentTarget').value),
                branch: document.getElementById('agentBranch').value
            };

            if(editDate && editName) {
                const idx = app.data.agents.findIndex(d => d.date === editDate && d.name === editName);
                if(idx > -1) app.data.agents[idx] = newRec;
            } else {
                const idx = app.data.agents.findIndex(d => d.date === newRec.date && d.name === newRec.name);
                if(idx > -1) app.data.agents[idx] = newRec;
                else app.data.agents.push(newRec);
            }

            app.renderDashboard();
            app.renderAgentTable();
            app.renderReports();
            document.getElementById('agentModal').style.display = 'none';
            app.showToast("Agent Data Saved");
        },

        calcAgentPreview: () => {
            const s = parseFloat(document.getElementById('agentSales').value) || 0;
            const o = parseInt(document.getElementById('agentOrders').value) || 0;
            const t = parseFloat(document.getElementById('agentTarget').value) || 0;
            document.getElementById('previewAvr').innerText = o>0 ? (s/o).toFixed(1) : 0;
            document.getElementById('previewAchv').innerText = t>0 ? ((s/t)*100).toFixed(0) : 0;
        },

        // --- BRANCH ENTRY ---
        openBranchModal: () => {
            document.getElementById('branchForm').reset();
            document.getElementById('editBranchId').value = "";
            document.getElementById('branchModal').style.display = 'flex';
        },
        editBranchData: (day) => {
            const currentData = app.getActiveData();
            const firstRec = currentData.find(d => d.day === day);
            if(firstRec) {
                document.getElementById('editBranchId').value = `${firstRec.day}|${firstRec.branch}`;
                document.getElementById('inpBranchChannel').value = app.currentChannel;
                document.getElementById('inpDay').value = firstRec.day;
                document.getElementById('inpBranch').value = firstRec.branch;
                document.getElementById('inpSales').value = firstRec.sales;
                document.getElementById('inpTxn').value = firstRec.txn;
                app.calcBranchAvr();
                document.getElementById('branchModal').style.display = 'flex';
            } else {
                app.openBranchModal();
                document.getElementById('inpDay').value = day;
            }
        },
        saveBranchData: (e) => {
            e.preventDefault();
            const channel = document.getElementById('inpBranchChannel').value;
            const day = parseInt(document.getElementById('inpDay').value);
            const branch = document.getElementById('inpBranch').value;
            const sales = parseFloat(document.getElementById('inpSales').value);
            const txn = parseFloat(document.getElementById('inpTxn').value);
            const avr = parseFloat(document.getElementById('inpAvr').value);

            const editId = document.getElementById('editBranchId').value;
            const targetData = channel === 'delivery' ? app.data.delivery : app.data.online;
            
            if(editId) {
                const idx = targetData.findIndex(d => d.day === day && d.branch === branch);
                if(idx > -1) targetData[idx] = { day, branch, sales, txn, avr };
            } else {
                const idx = targetData.findIndex(d => d.day === day && d.branch === branch);
                if(idx > -1) targetData[idx] = { day, branch, sales, txn, avr };
                else targetData.push({ day, branch, sales, txn, avr });
            }

            app.renderDashboard();
            app.renderTable();
            document.getElementById('branchModal').style.display = 'none';
            app.showToast("Branch Data Saved");
        },

        // --- EXECUTIVE REPORTS ---
        renderReports: () => {
            const sortType = document.getElementById('reportSort').value;
            
            let branchTotals = BRANCHES.map(b => {
                const d = [...app.data.delivery, ...app.data.online].filter(x => x.branch === b);
                const sales = d.reduce((a,c)=>a+c.sales,0);
                const txn = d.reduce((a,c)=>a+c.txn,0);
                return { name: b, sales, atv: txn>0 ? sales/txn : 0 };
            }).sort((a,b) => b.sales - a.sales);

            const topBranchHtml = branchTotals.slice(0, 3).map(b => `
                <li><span>${b.name}</span> <span class="val">${b.sales.toLocaleString()} AED</span></li>
            `).join('');
            document.getElementById('report-top-branches').innerHTML = topBranchHtml || '<li>No data</li>';

            const lowAgents = app.data.agents.filter(a => {
                const pct = a.target > 0 ? (a.sales/a.target)*100 : 100;
                return pct < 50 && a.sales > 0;
            }).sort((a,b) => (a.sales/a.target) - (b.sales/b.target));

            const lowPerfHtml = lowAgents.slice(0, 3).map(a => `
                <li><span>${a.name}</span> <span class="val" style="color:#D32F2F">${((a.sales/a.target)*100).toFixed(0)}%</span></li>
            `).join('');
            document.getElementById('report-low-performers').innerHTML = lowPerfHtml || '<li>All agents performing well!</li>';

            const metCount = app.data.agents.filter(a => a.sales >= a.target && a.target > 0).length;
            const activeCount = app.data.agents.filter(a => a.target > 0).length;
            document.getElementById('report-target-stats').innerHTML = `
                <li><span>Active Agents</span> <span class="val">${activeCount}</span></li>
                <li><span>On Target</span> <span class="val" style="color:var(--success)">${metCount}</span></li>
                <li><span>Success Rate</span> <span class="val">${activeCount ? ((metCount/activeCount)*100).toFixed(0) : 0}%</span></li>
            `;

            const cumStats = {};
            app.data.agents.forEach(d => {
                if(!cumStats[d.name]) cumStats[d.name] = { s:0, o:0, t:0 };
                cumStats[d.name].s += d.sales;
                cumStats[d.name].o += d.orders;
                cumStats[d.name].t += d.target;
            });

            const rankings = Object.keys(cumStats).map(name => {
                const stats = cumStats[name];
                const avr = stats.o > 0 ? (stats.s/stats.o) : 0;
                const pct = stats.t > 0 ? (stats.s/stats.t)*100 : 0;
                const status = pct >= 100 ? 'status-success' : (pct >= 50 ? 'status-warning' : 'status-danger');
                return { name, sales: stats.s, avr, pct, status };
            });

            if(sortType === 'sales') rankings.sort((a,b) => b.sales - a.sales);
            else rankings.sort((a,b) => b.pct - a.pct);

            const tbody = document.querySelector('#reportTable tbody');
            tbody.innerHTML = rankings.map((r, i) => `
                <tr>
                    <td>#${i+1}</td>
                    <td style="text-align:left; font-weight:bold;">${r.name}</td>
                    <td>${r.sales.toLocaleString()}</td>
                    <td>${avr.toFixed(1)}</td>
                    <td><span class="status-badge ${r.status}">${pct.toFixed(0)}%</span></td>
                </tr>
            `).join('');
        },

        // --- SETTINGS ---
        renderSettings: () => {
            document.getElementById('settingsBranchTable').innerHTML = BRANCHES.map(b => `
                <tr><td>${b}</td><td><i class="fas fa-trash" style="color:#ef4444; cursor:pointer;" onclick="app.removeBranch('${b}')"></i></td></tr>`).join('');
            document.getElementById('settingsAgentTable').innerHTML = AGENTS.map(a => `
                <tr><td>${a}</td><td><i class="fas fa-trash" style="color:#ef4444; cursor:pointer;" onclick="app.removeAgent('${a}')"></i></td></tr>`).join('');
        },
        openAddBranchModal: () => { document.getElementById('addBranchModal').style.display='flex'; },
        addNewBranch: () => {
            const name = document.getElementById('newBranchName').value;
            if(name) { BRANCHES.push(name); app.renderSettings(); app.setupUI(); document.getElementById('addBranchModal').style.display='none'; app.showToast("Branch Added"); }
        },
        removeBranch: (name) => { if(confirm('Delete '+name+'?')) { const i = BRANCHES.indexOf(name); if(i>-1) BRANCHES.splice(i,1); app.renderSettings(); app.setupUI(); } },
        openAddAgentModal: () => { document.getElementById('addAgentModal').style.display='flex'; },
        addNewAgent: () => {
            const name = document.getElementById('newAgentName').value;
            if(name) { AGENTS.push(name); app.renderSettings(); app.setupUI(); document.getElementById('addAgentModal').style.display='none'; app.showToast("Agent Added"); }
        },
        removeAgent: (name) => { if(confirm('Delete '+name+'?')) { const i = AGENTS.indexOf(name); if(i>-1) AGENTS.splice(i,1); app.renderSettings(); app.setupUI(); } },
        resetSystem: () => {
            if(confirm("DANGER: This will wipe ALL data. Are you sure?")) {
                app.data.delivery = []; app.data.online = []; app.data.agents = [];
                location.reload();
            }
        },

        showToast: (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    };

    document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
